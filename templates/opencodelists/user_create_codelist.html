{% extends "base-tw.html" %}

{% block title_extra %}Create a new codelist{% endblock %}

{% block content %}
  <form
    class="plausible-event-name=New+codelist flex gap-6 min-h-full flex-col justify-center py-20 sm:mx-auto sm:w-full sm:max-w-3xl sm:px-6 lg:px-8"
    enctype="multipart/form-data"
    id="newCodelistForm"
    method="POST"
  >
    <div class="sm:mx-auto text-center">
      <h1 class="text-2xl/9 font-bold tracking-tight text-slate-900">
        Create a new codelist
      </h1>
    </div>

    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="rounded-md bg-red-50 p-4">
        <div class="flex">
          <div class="shrink-0">
            {% icon_exclamation_circle_mini class="size-5 text-red-400" %}
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-red-800">{{ error_title }}</h3>
            <div class="text-sm text-red-700">
              <ul role="list" class="list-disc space-y-1 pl-5">
                {% for error in form.non_field_errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="bg-white px-6 py-12 flex flex-col gap-6 shadow-sm sm:rounded-lg sm:px-12">
      {% if form.owner %}
        {% form_input field=form.owner %}
      {% endif %}

      {% fragment as name_help_text %}
        <p>Describe the purpose of this codelist in 255 characters or fewer.</p>
        <p>You should use sentence case and spaces between words, rather than underscores or hyphens. Being descriptive is more important than being concise.</p>
        <p>For example: <strong>"Type 2 diabetes without retinopathy"</strong> is a better name than <strong>"diabetes"</strong>.</p>
      {% endfragment name_help_text %}
      {% form_input field=form.name help_text=name_help_text %}
    </div>

    <div class="bg-white px-6 py-12 shadow-sm sm:rounded-lg sm:px-12">
      {% fragment as coding_system_help_text %}
        <ul>
          {% for coding_system in coding_systems %}
            <li>
              <strong>{{ coding_system.name }}</strong>: {{ coding_system.description }}
              {% if coding_system.is_experimental %}
                <strong class="text-red-700">WARNING - this coding system is in testing and should only be used if you've been asked to test it.</strong>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% endfragment coding_system_help_text %}
      {% form_input field=form.coding_system_id help_text=coding_system_help_text %}
    </div>

    <div class="bg-white px-6 py-12 shadow-sm sm:rounded-lg sm:px-12">
      <div class="prose text-slate-700 mb-6">
        <h2 class="text-lg font-semibold">Upload a CSV <small>(optional)</small></h2>
        <p>If you have prepared a CSV of data, you can upload it here.</p>
      </div>

      <details class="group bg-blue-50 border-l-4 border-l-blue-900 mb-4 open:bg-gray-50 shadow-sm sm:rounded-sm" {% if form.csv_data.errors %}open{% endif %}>
        <summary class="cursor-pointer list-none before:!hidden [&amp;::-webkit-details-marker]:hidden">
          <span class="flex items-center justify-start gap-x-2 m-0 py-4 pr-6 pl-2 leading-none font-semibold text-blue-900 group-open:text-blue">
            {% icon_plus_to_minus class="max-w-5 fill-blue-900 group-open:fill-blue" %}
            <span>Upload CSV</span>
          </span>
        </summary>
        <div class="border-t border-t-blue-100 py-6 pl-10 pr-6">
          {% form_input_upload field=form.csv_data %}

          <!-- Loading indicator -->
          <div id="csv-loading" class="mt-6 hidden">
            <div class="flex items-center gap-3 text-slate-700">
              <svg class="animate-spin h-5 w-5 text-blue-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span class="text-sm">Processing CSV...</span>
            </div>
          </div>

          <!-- CSV Preview and Detection Results -->
          <div id="csv-analysis-section" class="rounded-md outline-2 -outline-offset-1 outline-slate-300 hidden">
            <div class="bg-slate-100 p-4 rounded-sm mb-4">
              <div class="text-sm text-slate-700 mb-3">
                <h2 class="text-lg font-semibold text-slate-900 mb-4">Detected structure</h2>
                <ul class="list-disc pl-5 mt-2 space-y-1">
                  <li id="no-header-detected">No header row detected</li>
                  <li id="header-detected">
                    <span id="detected-header-rows" class="font-mono font-semibold text-black">-</span>
                    <span class="inline-block rounded-sm border border-slate-200 bg-yellow-100 px-1 py-0.5 font-medium text-yellow-900">header</span>
                    row<span id="detected-header-rows-plural"></span> detected, data starts at row
                    <span id="detected-data-start" class="font-mono font-semibold text-black">-</span>
                  </li>
                  <li>
                    <span id="detected-code-count" class="font-mono font-semibold text-black">-</span>
                    <span id="detected-coding-system" class="inline-block rounded-sm border border-slate-200 px-1 py-0.5 bg-blue-100 text-black font-bold">-</span>
                    code<span id="detected-code-count-plural"></span> in column
                    <span id="detected-code-column" class="font-mono font-semibold text-black">-</span>
                  </li>
                </ul>
              </div>
              <div class="mt-3 bg-white border border-slate-300 rounded-sm overflow-auto max-h-64">
                <table class="text-xs border-collapse w-full">
                  <tbody id="csv-preview-table">
                  </tbody>
                </table>
              </div>
              <div id="csv-warnings" class="mt-4 text-sm text-red-700 hidden">
                <p class="font-semibold">Warning:</p>
                <p id="csv-warning-message"></p>
                <p>This will fail to create a codelist, so please edit the csv file and try again</p>
              </div>
            </div>
          </div>

          <!-- Error display -->
          <div id="csv-errors" class="mt-6 hidden">
            <div class="rounded-md bg-red-50 p-4">
              <div class="flex">
                <div class="shrink-0">
                  {% icon_exclamation_circle_mini class="size-5 text-red-400" %}
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-red-800">There is a problem with your CSV:</h3>
                  <p id="csv-error-message" class="text-sm text-red-700"></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </details>
    </div>

    <div class="text-center mt-4 text-slate-700">
      <p>The next step will allow you to prepare your codelist for use.</p>
    </div>

    <button
      class="flex w-fit mx-auto justify-center cursor-pointer rounded-md bg-green-700 px-3 py-1.5 text-sm/6 font-semibold text-white shadow-xs transition-colors hover:bg-green-600 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-700 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-green-700"
      type="submit"
    >
      Create a draft codelist
    </button>
  </form>
{% endblock %}

{% block extra_js %}
  <script>
    /* -------- "plausible" event tracking for coding system selection -------- */
    const selectInput = document.getElementById(
      "{{ form.coding_system_id.id_for_label }}",
    );
    const newCodelistForm = document.getElementById("newCodelistForm");
    const newCodelistFormClassList = newCodelistForm.classList.toString();
    selectInput.addEventListener("change", (e) => {
      const codingSystemId = e.target.value.toLowerCase().replace(/\W/g, "");
      newCodelistForm.classList = `${newCodelistFormClassList} plausible-event-newcodelist=${codingSystemId}`;
    });

    // Duplicate of the function in _utils.ts - but this file is pure JS so can't import it
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    const fileInput = document.querySelector('input[type="file"][name="csv_data"]');
    const helpTextDiv = document.getElementById('id_{{ form.csv_data.html_name }}_helptext');
    const loadingDiv = document.getElementById('csv-loading');
    const analysisSection = document.getElementById('csv-analysis-section');
    const errorDiv = document.getElementById('csv-errors');
    const errorMessageEl = document.getElementById('csv-error-message');
    const dataStartEl = document.getElementById('detected-data-start');
    const detectedHeaderRowsEl = document.getElementById('detected-header-rows');
    const detectedHeaderRowsPluralEl = document.getElementById('detected-header-rows-plural');
    const codeCountEl = document.getElementById('detected-code-count');
    const detectedCodeCountPluralEl = document.getElementById('detected-code-count-plural');
    const noHeaderEl = document.getElementById('no-header-detected');
    const headerEl = document.getElementById('header-detected');
    const codeColumnEl = document.getElementById('detected-code-column');
    const codingSystemEl = document.getElementById('detected-coding-system');
    const previewTable = document.getElementById('csv-preview-table');
    const warningsDiv = document.getElementById('csv-warnings');
    const csvWarningMessage = document.getElementById('csv-warning-message');


    function clearAnalysis() {
      helpTextDiv.classList.remove('hidden');
      loadingDiv.classList.add('hidden');
      analysisSection.classList.add('hidden');
      errorDiv.classList.add('hidden');
      previewTable.innerHTML = '';
    }

    function renderCsvPreview(rows, numberOfRows, firstDataRowIdx, codeColumnIdx) {
      previewTable.innerHTML = '';

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const tr = document.createElement('tr');
        if(i < firstDataRowIdx) {
          tr.className = 'bg-yellow-100'; // Header row(s) styling
        }

        for (let j = 0; j < row.length; j++) {
          const td = document.createElement('td');
          td.className = 'border border-slate-200 px-2 py-1';
          if (j === codeColumnIdx && i >= firstDataRowIdx) {
            td.className += ' bg-blue-100 font-bold'; // Clinical code column styling
          } else if (i < firstDataRowIdx) {
            td.className += ' text-yellow-900 font-medium font-semibold'; // Header row text styling
          } else {
            td.className += ' text-slate-700'; // Non-header, non clinical code cells
          }
          td.textContent = row[j] || '';
          tr.appendChild(td);
        }
        previewTable.appendChild(tr);
      }

      // append row with ellipsis if more rows exist
      if (numberOfRows + firstDataRowIdx > rows.length) {
        const tr = document.createElement('tr');
        for (let j = 0; j < rows[0].length; j++) {
          const td = document.createElement('td');
          td.className = 'border border-slate-200 px-2 py-1 text-slate-700';
          if (j === codeColumnIdx) {
            td.className += ' bg-blue-100 font-semibold';
          }
          td.textContent = '...' + (numberOfRows - rows.length + firstDataRowIdx) + ' more rows';
          tr.appendChild(td);
        }
        previewTable.appendChild(tr);
      }
    }

    function displayError(message = 'Unknown error') {
      loadingDiv.classList.add('hidden');
      analysisSection.classList.add('hidden');
      errorDiv.classList.remove('hidden');
      errorMessageEl.textContent = message;
    }

    function renderHeaderRowBullet(dataStartRow, firstDataRowIdx) {
      // Render "data starts at row X"...
      dataStartEl.textContent = `${dataStartRow}`;

      if(firstDataRowIdx > 0) {
        // Header row detected
        detectedHeaderRowsEl.textContent = firstDataRowIdx;
        if (firstDataRowIdx > 1) {
          detectedHeaderRowsPluralEl.textContent = 's';
        } else {
          detectedHeaderRowsPluralEl.textContent = '';
        }
        headerEl.classList.remove('hidden');
        noHeaderEl.classList.add('hidden');
      } else {
        // No header row detected
        noHeaderEl.classList.remove('hidden');
        headerEl.classList.add('hidden');
      }
    }

    function renderCodingSystemBullet(detectedSystem, numberOfRows, codeColIdx) {
      codeColumnEl.textContent = codeColIdx + 1;

      if (numberOfRows === 1) {
        detectedCodeCountPluralEl.textContent = '';
      } else {
        detectedCodeCountPluralEl.textContent = 's';
      }
      codingSystemEl.textContent = detectedSystem || 'Unknown';
      codeCountEl.textContent = numberOfRows;
    }

    function renderWarning(warning) {
      if (warning) {
        csvWarningMessage.textContent = warning;
        warningsDiv.classList.remove('hidden');
      } else {
        warningsDiv.classList.add('hidden');
      }
    }

    async function handlePreview() {
      clearAnalysis();
      const file = fileInput.files && fileInput.files[0];
      if (!file) return;

      loadingDiv.classList.remove('hidden');

      try {
        const formData = new FormData();
        formData.append('csv_data', file, file.name || 'upload.csv');
        const codingSystemId = selectInput.value;
        if (codingSystemId) {
          formData.append('coding_system_id', codingSystemId);
        }

        const url = "{% url 'csv-descendants-preview' username=user.username %}";
        const resp = await fetch(url, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'fetch',
            'X-CSRFToken': getCookie('csrftoken') || ''
          }
        });

        loadingDiv.classList.add('hidden');

        const data = await resp.json();
        if (!resp.ok) {
          displayError(data.error);
          return;
        }

        // Hide help text after successful upload
        helpTextDiv.classList.add('hidden');
        analysisSection.classList.remove('hidden');

        const numberOfRows = data.uploaded_count || 0;
        const firstDataRowIdx = data.detected_first_data_row || 0;
        const codeColIdx = data.detected_code_column || 0;
        const detectedSystem = data.detected_coding_system_id;
        // Convert 0-based first_data_row_idx to 1-based display
        const dataStartRow = firstDataRowIdx + 1;

        renderWarning(data.warning);
        renderHeaderRowBullet(dataStartRow, firstDataRowIdx);
        renderCodingSystemBullet(detectedSystem, numberOfRows, codeColIdx);
        renderCsvPreview(data.rows_preview, numberOfRows, firstDataRowIdx, codeColIdx);
      } catch (e) {
        displayError(`An unexpected error occurred while analyzing the CSV: ${e.message}`);
      }
    }

    fileInput.addEventListener('change', handlePreview);

    selectInput.addEventListener('change', () => {
      if (fileInput.files && fileInput.files.length) handlePreview();
    });
  </script>
{% endblock %}
